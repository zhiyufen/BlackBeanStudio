## 实用代码片段

[TOC]

## 1. Android功能相关

### 1.1 锁屏相关

#### 1.1.1 判断当前锁屏状态

```java
public static boolean isScreenLock() {
        KeyguardManager km =
                (KeyguardManager) activity.getApplicationContext().getSystemService(Context.KEYGUARD_SERVICE);
        //noinspection ConstantConditions
        return km.inKeyguardRestrictedInputMode();
    }
```

#### 1.1.2 唤醒屏幕并解锁

添加权限：

```groovy
<uses-permission android:name="android.permission.WAKE_LOCK" />
##不确定下面要不要
<uses-permission android:name="android.permission.DISABLE_KEYGUARD" />
```

Demo

```java
//某Activity
@Override
    protected void onCreate(@Nullable Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        getWindow().addFlags(WindowManager.LayoutParams.FLAG_SHOW_WHEN_LOCKED | WindowManager.LayoutParams.FLAG_TURN_SCREEN_ON);

        //for Android 8.0: Only fullscreen opaque activities can request orientation
        if (Build.VERSION.SDK_INT != Build.VERSION_CODES.O) {
            setRequestedOrientation(ActivityInfo.SCREEN_ORIENTATION_PORTRAIT);
        }
        wakeScreen();
        dismissLockScreen();
		//跳转锁屏后界面，但个人觉得应该放在KeyguardDismissCallback里
        Intent newIntent = new Intent(CallReservationActivity.this, MainActivity.class);
        ...
        startActivity(newIntent);
        finish();
    }

//具体方法
	private void wakeScreen() {
        PowerManager powerManager = (PowerManager) getSystemService(Context.POWER_SERVICE);
        if (powerManager != null && !powerManager.isInteractive()) {
            powerManager.semWakeUp(SystemClock.uptimeMillis(), 0, "Wakeup to show " + getPackageName());
        }
    }

    /**
     * Request to dismiss the lock screen.
     *
     * @param activity The activity which request to unlock the screen
     * @param callback The callback to be called if the request to dismiss Keyguard was successful
     *                 or null if the caller isn't interested in knowing the result. The callback
     *                 will not be invoked if the activity was destroyed before the callback was
     *                 received.
     * @Attention before this function, you should check the status of lock screen by yourself (use isScreenLock() above)
     */
    public static void requestDismissLockScreen(Activity activity, KeyguardManager.KeyguardDismissCallback callback) {
        if (Build.VERSION.SDK_INT < Build.VERSION_CODES.O || callback == null) {
            return;
        }
        KeyguardManager keyguardManager = (KeyguardManager) activity.getApplicationContext().getSystemService(Context.KEYGUARD_SERVICE);
        if (keyguardManager == null) {
            callback.onDismissError();
            return;
        }
        keyguardManager.requestDismissKeyguard(activity, callback);
    }
```

### 1.2 判断某应用是否安装

比如支付宝：

```java
    public static boolean isPackageInstalled(String packagename, PackageManager packageManager) {
        try {
            packageManager.getPackageInfo(packagename, PackageManager.GET_ACTIVITIES);
            return true;
        } catch (PackageManager.NameNotFoundException e) {
            return false;
        }
    }
    public static boolean isAliPayInstalled(@NonNull Context context) {
        return isPackageInstalled(ALIPAY_PACKAGE_NAME, context.getPackageManager());
    }    
```



### 1.3 请求“显示顶部” 权限

```kotlin
// 跳转应用相应显示顶部权限界面
val intent = Intent(Settings.ACTION_MANAGE_OVERLAY_PERMISSION)
intent.data = Uri.parse("package:" + SReminderApp.getInstance().packageName)
startActivityForResult(intent, REQUEST_APPEAR_ON_TOP_PERMISSION_CODE)

//在显示顶部权限界面的返回处理
    @Override
    protected void onActivityResult(int requestCode, int resultCode, @Nullable Intent data) {
        super.onActivityResult(requestCode, resultCode, data);
        if (requestCode == REQUEST_APPEAR_ON_TOP_PERMISSION_CODE) {
            if (Settings.canDrawOverlays(this)) {
                //用户已允许
            } else {
                //用户没允许
            }
        }
    }
```



## 2. 工具类方法

### 2.1 两个字符串数字(包含小数点)的进行相加，一般使用于大数值的相加。

```kotlin

    /**
     * 整数大数字符串相加
     *
     * @isDecimal 是否为小数点后面的数
     */
    private fun addInteger(s1: String, s2: String, isDecimal: Boolean = false): String {
        val result = StringBuilder()
        var reversalS1 = s1
        var reversalS2 = s2
        var len1 = reversalS1.length
        var len2 = reversalS2.length
        // 针对小数点后面的数，需要提前补0再反转
        if (isDecimal) {
            //不足位补0，对齐数字
            if (len1 > len2) {
                for (i in len2 until len1) reversalS2 += "0"
            } else if (len1 < len2) {
                for (i in len1 until len2) reversalS1 += "0"
            }
        }

        //反转字符串，便于从低位相加
        reversalS1 = StringBuilder(reversalS1).reverse().toString()
        reversalS2 = StringBuilder(reversalS1).reverse().toString()

        if (!isDecimal) {
            len1 = reversalS1.length
            len2 = reversalS2.length
            if (len1 > len2) {
                for (i in len2 until len1) reversalS2 += "0"
            } else if (len1 < len2) {
                for (i in len1 until len2) reversalS1 += "0"
            }
        }

        val maxLen = if (len1 > len2) len1 else len2
        //溢出标志位
        var overflow = false
        //进位标志位
        var takeflow = 0
        //逐位相加
        for (i in 0 until maxLen) {
            if (i == maxLen - 1) {
                val sum = reversalS1[i].toString().toInt() + reversalS2[i].toString().toInt() + takeflow
                takeflow = if (sum > 9) {
                    result.append(sum - 10)
                    overflow = true
                    1
                } else {
                    result.append(sum)
                    0
                }
            } else {
                val sum = reversalS1[i].toString().toInt() + reversalS2[i].toString().toInt() + takeflow
                takeflow = if (sum > 9) {
                    result.append(sum - 10)
                    1
                } else {
                    result.append(sum)
                    0
                }
            }
        }
        if (overflow) {
            result.append(1)
        }
        return result.reverse().toString()
    }
```

### 2.2 如何将Intent对象转化为 byte[], 以便进行放入ContextValues类中？

```java
   /**
     * Intent对象转化为 byte 数组.
     */
    public static byte[] getBytesFromIntent(Intent intent) {
        if (intent == null) {
            return null;
        }

        Parcel parcel = Parcel.obtain();
        intent.writeToParcel(parcel, 0);
        byte[] bytes = parcel.marshall();
        parcel.recycle();

        return bytes;
    }

	byte[] actionData = getBytesFromIntent(getData());
```

### 2.3 获取Http请求的真实IP

```java
/**
 * 获取真实IP
 * @param request 请求体
 * @return 真实IP
 */
public static String getRealIp(HttpServletRequest request) {
	// 这个一般是Nginx反向代理设置的参数
    String ip = request.getHeader("X-Real-IP");
    if (ip == null || ip.length() == 0 || "unknown".equalsIgnoreCase(ip)) {
        ip = request.getHeader("X-Forwarded-For");
    }
    if (ip == null || ip.length() == 0 || "unknown".equalsIgnoreCase(ip)) {
        ip = request.getHeader("Proxy-Client-IP");
    }
    if (ip == null || ip.length() == 0 || "unknown".equalsIgnoreCase(ip)) {
        ip = request.getHeader("WL-Proxy-Client-IP");
    }
    if (ip == null || ip.length() == 0 || "unknown".equalsIgnoreCase(ip)) {
        ip = request.getRemoteAddr();
    }
    // 处理多IP的情况（只取第一个IP）
    if (ip != null && ip.contains(",")) {
        String[] ipArray = ip.split(",");
        ip = ipArray[0];
    }
    return ip;
}
```



## 3.文件操作相关

### 3.1 Android app资源读取

#### 3.1.1 如何读取 Asset 目录下的内容？

```kotlin
public String getContent( String fn) {
	val assetManager = SReminderApp.getInstance().assets
        var inputStream: InputStream? = null
        return try {
            inputStream = assetManager.open("xxx.json", AssetManager.ACCESS_BUFFER)
            val sb = StringBuilder()
            val buffer = ByteArray(inputStream.available())
            while (inputStream.read(buffer) != -1) {
                sb.append(String(buffer))
            }
            sb.toString()
        } catch (e: FileNotFoundException) {
            e.printStackTrace()
            null
        } catch (e: IOException) {
            e.printStackTrace()
            null
        } finally {
            inputStream?.close()
        }
}  
```

#### 3.1.2 如何读取 Res下面 Raw 文件内容？

```java
	//id = R.raw.xxxx
    public final static String loadRawFileToString(Context context, int id) {
        String result = null;
        InputStream inputStream = context.getResources().openRawResource(id);
        byte[] txt = null;
        try {
            txt = new byte[inputStream.available()];
            int size = inputStream.read(txt);
            if (size <= 0)
                return null;

            result = new String(txt, "UTF-8");
        } catch (IOException e) {
            e.printStackTrace();
            SAappLog.e("Read inputstream throws IOException : " + e.getMessage());
        } finally {
            try {
                inputStream.close();
            } catch (IOException e) {
                SAappLog.e("Close inputstream throws IOException : " + e.getMessage());
            }
        }
        return result;
    }
```

