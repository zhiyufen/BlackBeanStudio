## 后台任务笔记

[TOC]

### 1.0 后台处理Guide

一般来说，运行时间超过几毫秒的所有任务都应委派给台线程。长时间运行的常见任务包括解码位图、访问存储空间、处理机器学习 (ML) 模型、执行网络请求等。

#### 任务类别

后台任务分为以下几个主要类别：

- 即时任务(Immediate)： 需要马上运行任务并且任务很快完成；
- 长期任务(Long Running)： 需要长时间才能完成任务（超过10分钟的）
- 可延期任务(Deferrable)： 不需要马上运行，在后面某个时间运行；

而这三类又可分为持续性和非持续性：

- 持续性： 即使app重启或手机重启，仍需要运行的任务；
- 非持续性： 当进程退出后，不再运行任务(运行中的任务也会马上停止)

大多数任务不需要在精确的时间点运行。通常，任务允许运行的时间点存在细微差异，具体取决于网络可用性和剩余电量等条件。无需在精确时间点运行的任务应归类为可延期任务。

![](https://developer.android.com/images/guide/background/background.svg)

#### 推荐方案

| 类别                   | 持续性      | 非持续性                                             |
| :--------------------- | :---------- | :--------------------------------------------------- |
| 即时任务(Immediate)    | WorkManager | 协程                                                 |
| 长期任务(Long Running) | WorkManager | 不推荐这种任务， 可改成持续性任务并用WorkManager实现 |
| 可延期任务(Deferrable) | WorkManager | 不推荐这种任务， 可改成持续性任务并用WorkManager实现 |

#### Alarms任务

针对需要精确时间来运行任务的，需要使用AlarmManager来进行定时启动；

注： 当使用AlarmManager安排后台工作时，它会将设备从瞌睡模式唤醒，因此其使用可能会对电池寿命和整体系统健康产生负面影响。你的应用程序将对这些影响负责。

#### 取代前台Service的方案

Android 12 已限制从后台启动前台服务了。 大多情况下，我们应该使用WorkManager并设置 setForeground() 来代替自己启动一个前台服务， 这使WorkManager能够管理foregound服务的生命周期，确保效率；

当然对于长时间运行并且需要告知用户的任务，我们仍然使用前台服务； 但需要确保正确关闭服务秋释放资源；

一般直接使用前台服务的用例：

- 媒体播放
- 活动跟踪
- 位置共享
- 语音或视频通话